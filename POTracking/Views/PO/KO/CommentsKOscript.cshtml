<script type="text/javascript" language="javascript" defer="defer">        
var IsCCEditMode = false;
var NextNewCommentID = -1;
var commentsViewModel = function () {
    var self = this;
    self.emptyComment = "";

    self.commentToAdd = ko.observable();
    self.allComments = ko.observableArray();
    self.AssignTo = ko.observable();
    self.AssignToVal = ko.observable();
    @*//self.jsonText = ko.computed(function() { return ("JSON: " + ko.toJSON(self.commentToAdd())); });*@

    self.setEdited = function (comment) {
        comment._Edited(!comment._Added());
        comment.PostedOn(Date111); 
    }
    self.setEditedFlag = function (comment) {
        comment._Edited(!comment._Added());
        comment.LastModifiedDate(Date111);
        comment.PostedOn(Date111); 

        /*var index = self.allComments.indexOf(comment);
        self.allComments.remove(comment);
        self.allComments.splice(index, 0, comment);*/
    }
    self.addComment = function (comment) {
        if (comment.Comment1 == null || comment.Comment1 == "")            
            {@*//http://knockoutjs.com/documentation/event-binding.html*@
                alert("Comment is a required field"); 
                return false; 
            }
        else {
            if (!IsCCEditMode) {
                comment.ID = NextNewCommentID;
                self.allComments.push(ko.mapping.fromJS(cloneObservable(comment)));

                self.sendEmailPost(comment);

                NextNewCommentID = NextNewCommentID - 1;
                self.emptyComment.ID = NextNewCommentID; // NOT WORKING as expected
                    
                self.cancelComment(comment);//commentToAdd(cloneObservable(self.emptyCommment));
            } 
            else {
                @*//HT: if observable is set correctly nothing needs to be done
                /*var index = self.allComments.indexOf(comment);
                self.allComments.remove(comment);
                self.allComments.splice(index, 0, comment);*/*@
            }
        }
        return true; @*// because we need to ajax submit the form *@
    };        

    self.removeSelected = function (comment) {
        if (comment != null)
        {
            comment._Deleted(true);
            if (comment._Added()) {
                comment._Added(false);
                self.allComments.remove(comment);
            }
        }
    };

    self.unRemoveSelected = function (comment) {
        if (comment != null) // Prevent blanks and duplicates
        {
            comment._Deleted(false);
        }
    };


    self.cancelComment = function (comment) {
        IsCCEditMode = false;
        @*comment.allComments().valueHasMutated();//SO: 8537397
        //ko.mapping.fromJS(self.selectedComment, self.commentToAdd); *@
        self.commentToAdd(cloneObservable(self.emptyComment));
    };

    self.sendEmailPost = function (comment) {
        var _AssignTo = $("#AssignTo").val();
        var _PONumber = $("#PONumber").val();
        var proceed = false;
        proceed = !(comment == null || _AssignTo == null || _PONumber == null);
            
        if(proceed){
            $.post('@Url.Action("CommentsKOEmail", "PO", new { POGUID = ViewData["POGUID"] })',
                    { 
                    CommentObj: ko.mapping.toJSON(comment),
                    AssignTo: _AssignTo,
                    PONumber : _PONumber
                    },  
                    function (result) {   
                    //alert(result); HT: we can notify user if a succesful email was sent
                    }
            );
        }
    };

    self.saveToServer = function () {
        ko.utils.postJson(location.href, { comments: ko.mapping.toJS(self.allComments) }); //ko.toJSON(self.allComments)
        return false;
    }

    @*http://jsfiddle.net/rniemeyer/GgFa9/
    self.jsonText = ko.computed(function() {
    return JSON.stringify($.map(self.allComments(), function (comment) { return comment.val(); }));
    });*@
};
var viewModelComments = new commentsViewModel();
function createCommentsKO()
{
    var POAssignTo = '@ViewData["AssignTo"]';// $("#AssignTo1").val();
    $.getJSON('@Html.Raw(Url.Action("CommentsKOVM", "PO", new { POGUID = ViewData["POGUID"] }))' +  '&AssignTo=' + POAssignTo ,
        function (data) {
            if (data.CommentToAdd.ID != -1) 
            data.CommentToAdd.ID = NextNewCommentID;

            viewModelComments.emptyComment = data.EmptyComment; @*// THIS SHUD NOT BE AN OBSERVABLE*@
            viewModelComments.AssignTo(data.AssignTo);   $("#AssignToOLD").val(data.AssignTo);
            viewModelComments.AssignToVal("");
             
            viewModelComments.commentToAdd(data.CommentToAdd);@*//var mapping = {'ignore': ["PostedOn"]};*@
            viewModelComments.allComments = ko.mapping.fromJS(data.AllComments); //, mapping);
            viewModelComments.Users = ko.mapping.fromJS(data.Users);
             
            @*
            //$("#commentTemplate").tmpl(data.AllComments).appendTo( "#tbComments" );
            // viewModelComments.jsonText = ko.dependentObservable(function() {
            // if(this.allComments() != null)  return ("JSON: " + ko.toJSON(this.allComments())); }, this);
            *@
            @*alert('PO-Comments');*@
            ko.applyBindings(viewModelComments, document.getElementById("divComments"));
        });
}

function doCmtDelPost(comment) {
    var data = {}; data[txtId] = txtVal;
    var url = '@Html.Raw(Url.Action("CommentKODelete", "PO", new { POGUID = ViewData["POGUID"] }))';
    $.post(url, data);
    return false; // prevent any postback
}
     
    // Put script at bottom to avoid early-references
@*
HT:CAUTION - using document.ready causes duplicate call which replicates the binding!
$(document).ready(function () {
    setFocus("Comment1");        
    createCommentsKO();
});*@

function callDocReadyComments()
{
    createCommentsKO();
    //setFocus("Comment1");
}

function setAssignTo(ddl)
{
    var ddlID = $(ddl).val();
    var ddlTXT = $(ddl).children("option").filter(":selected").text();
        
    $(ddl).parent().children("input:first").val(ddlTXT).trigger("change");        

    $("#AssignToVal").val(ddlTXT).trigger("change");
    //Special case for the field in Info tab
    $("#AssignTo1").val(ddlID).trigger("change");
}
</script>   